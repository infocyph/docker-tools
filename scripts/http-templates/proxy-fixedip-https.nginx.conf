# proxy-fixedip-https.nginx.conf
# Client: https://{{SERVER_NAME}}  â†’  Upstream: https://{{PROXY_IP}}:443 (SNI/Host = {{PROXY_HOST}})

server {
    listen 443 ssl;
    http2 on;
    server_name {{SERVER_NAME}} www.{{SERVER_NAME}};

    ssl_certificate /etc/mkcert/nginx-server.pem;
    ssl_certificate_key /etc/mkcert/nginx-server-key.pem;
    ssl_trusted_certificate /etc/share/rootCA/rootCA.pem;

    {{CLIENT_VERIFICATION}}

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    access_log /var/log/nginx/{{SERVER_NAME}}.access.log;
    error_log  /var/log/nginx/{{SERVER_NAME}}.error.log;

    client_max_body_size {{CLIENT_MAX_BODY_SIZE}};

    location / {
        proxy_pass https://{{PROXY_IP}}:443;

        include /etc/nginx/proxy_params;
        include /etc/nginx/proxy_timeouts;
        include /etc/nginx/proxy_buffers;

        # Upstream vhost routing
        proxy_set_header Host {{PROXY_HOST}};

        # HTTPS-to-IP upstream: force correct SNI
        proxy_ssl_server_name on;
        proxy_ssl_name {{PROXY_HOST}};

        proxy_redirect off;

        {{PROXY_COOKIE_EXACT_INCLUDE}}
        {{PROXY_COOKIE_PARENT_INCLUDE}}
        {{PROXY_REDIRECT_INCLUDE}}
        {{PROXY_WS_INCLUDE}}
        {{PROXY_STREAMING_INCLUDE}}
        {{PROXY_SUBFILTER_INCLUDE}}
        {{PROXY_CSP_INCLUDE}}

        proxy_intercept_errors off;
    }
}
