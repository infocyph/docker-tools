#!/bin/bash
set -euo pipefail

HOST="${NOTIFY_HOST:-127.0.0.1}"
PORT="${NOTIFY_TCP_PORT:-9901}"
TOKEN="${NOTIFY_TOKEN:-}"

timeout="2500"
urgency="normal"

usage() { echo "Usage: notify [-t ms] [-u low|normal|critical] <title> <body>" >&2; exit 2; }

while getopts ":t:u:" opt; do
  case "$opt" in
    t) timeout="$OPTARG" ;;
    u) urgency="$OPTARG" ;;
    *) usage ;;
  esac
done
shift $((OPTIND - 1))

[[ $# -ge 2 ]] || usage

title="$1"
body="$2"

# Flatten tabs/newlines so it's always one-line protocol
title="${title//$'\n'/ }"; title="${title//$'\r'/ }"; title="${title//$'\t'/ }"
body="${body//$'\n'/ }";  body="${body//$'\r'/ }";  body="${body//$'\t'/ }"

# Send one line over TCP
printf "%s\t%s\t%s\t%s\t%s\n" "$TOKEN" "$timeout" "$urgency" "$title" "$body" \
  | nc -w 1 "$HOST" "$PORT"
